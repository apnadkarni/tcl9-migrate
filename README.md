# Migration tool for Tcl 9

This software is intended to help identify changes needed for porting
Tcl 8 scripts to Tcl 9. It has two modes of operation:

- a static analyzer based on Nagelfar that runs under both
  Tcl 8.6 and 9 logging warnings for potential incompatibilities.

- a runtime analyzer. This is intended to only run under Tcl 9.
  It attempts to fix up invalid code (e.g. tilde references) at
  run time allowing the program to continue to run but logs
  warnings to stderr.

It is expected the runtime analyzer is run only after fixing the
incompatibilities reported by the static analyzer.

## Requirements

The detection and checks for file encodings requires the ICU libraries
to be present on the system at runtime. These should already be present
on Windows 11 and recent versions of Windows 10. On other platforms,
install them via the package manager if not already installed.

## Static checks

The static analyzer may be run either with Tcl 8.6 or 9. However, the latter is
strongly suggested as the former will not detect encoding error conditions in
source files.

To run the static analyzer,

```
tclsh migrate.tcl check ?options? ?--? ?GLOBPAT ...?
```

where `GLOBPAT` is a file glob pattern. Each file matching the pattern is
examined and warnings for any potential incompatibilities are printed to
standard output. If the `--encodingsonly` or `-e` option is specified, no static
analysis is done, only file encodings are checked.

The warnings and errors generated by the static checker include those from
Nagelfar unrelated to Tcl 9 migration. The Tcl 9 related warnings generally have
a `[TAG]` at the end. If the `--migrationonly` or `-m` option is specified, only
warnings related to Tcl 9 migration are reported.


## Runtime checks

The runtime checks are intended to be used with Tcl 9. To enable the
checks, either extract the distribution into a directory on Tcl's
`auto_path`, or use the `install` command to install the package.

```
tclsh migrate.tcl install ?DIR?
```

If `DIR` is not specified the package will be installed in the last
directory in `auto_path` that is located in the native file system.

Then at the top of your main application, add the following lines:

```
package require tcl9migrate
tcl9migrate::runtime::enable
```

Note the main application file must have the correct encoding (UTF-8). As
recommended, use the static analyzer first to verify this. If other sourced are
not, appropriate warnings will be generated.

The runtime checks include

- Correct file encodings. In case of encoding failures, the correct encoding is
**guessed** to permit the program to continue and a warning printed to standard
error.

- Use of tildes in `open**, `file** and similar commands. These are expanded
appropriately allowing the program to run with a warning printed to standard
error.

## Warnings

**Both static and runtime warnings may include false positives.**
Any changes should be made keeping that in mind.

The following warnings may be emitted by the tool:

### \[DATAENCODING\]

The encoding for a data file argument to `open` was not that expected. The expected
encoding is the one returned by `encoding system`. The generated
message may be ignored if there is already a following call to `fconfigure` to
set the appropriate encoding. The runtime check does not detect that.

In all cases, the suggested encoding is **only a guess** and should be verified
by other means. The referenced file should be converted as appropriate or an
appropriate `fconfigure` command added to set the correct encoding. On
Unix/Linux, encoding conversion can be done with the `iconv` utility which is
present in most distributions. It is also available for Windows as a download
from several sites.

### \[SOURCEENCODING\]

The encoding for a sourced Tcl script not that expected. The expected
encoding is either one specified with the `-encoding` option or the default
`utf-8`. It is recommended that Tcl scripts be converted to UTF-8. If that is
not desirable for any reason, an `-encoding` option to the `source` command
needs to be added when sourcing those files.

In all cases, the suggested encoding is **only a guess** and should be verified
by other means. The referenced file should be converted as appropriate. On
Unix/Linux this can be done with the `iconv` utility which is present in most
distributions. It is also available for Windows as a download from several
sites.

### [\TILDEEXPAND\]

Tcl 9 does not do implicit tilde expansion in file paths.
For example, Tcl 8 code such as

```
set fd [open ~/tclshrc.tcl]
```

will fail with a *no such file or directory* error.

Rewrite the code to do explicit expansion using
`file tildeexpand` or `file home`.

```
set fd [open [file tildeexpand ~/tclshrc.tcl]]
```

### \[OCTAL\]

Tcl 9 expressions do not interpret strings of the
form `0NNN` as octal representation of integers. Replace with the
`0oNNN` representation. Note that the permissions argument or
option for the `open` and `file attributes` commands respectively
will still accept the old octal notation but returned values will
use the newer octal notation.

The migration script limits its checks to use in expressions,
(`expr`, `if` etc.) as a generalized check generates too many
false positives as 0-prefixed numeric strings are often used as
plain string arguments.

### \[RELATIVENSVAR\]

In Tcl 8, references to variables qualified with **relative**
namespaces were looked up in the global namespace as well. For example,
a reference to `ns2::var` from within the `::ns` namespace would
search for `::ns::ns2::var` and if not found, look for `::ns2::var`
as well. This is no longer the case in Tcl 9. If the `ns2` reference
was with respect to the global namespace, the reference needs to
be explicitly qualified as `::ns2::var`.

### \[NOSUCHENCODING\]

The encoding is not available in Tcl 9.

## Credits

The static analyzer uses a custom version of Peter Spjuth's
[Nagelfar](https://nagelfar.sourceforge.net/index.html).
